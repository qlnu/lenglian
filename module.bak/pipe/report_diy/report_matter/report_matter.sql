//旧语句,已不使用
sql.pipe.report_diy.report_matter.query.count =  main,select count(*)  from (select to_char(axiom_utc_to_date(?), 'yyyy-mm-dd'), to_char(axiom_utc_to_date(?), 'yyyy-mm-dd'), attt.target_name, attt.target_id, nvl(atptt.patrol_count,0) patrol_count, nvl(aastt.speed_count,0) speed_count, nvl(aartt.region_count,0) region_count, nvl(aaptt.point_count,0) point_count, trunc(salaryt.day_pass * patt.month_salary / 30,2) as money,trunc(salaryt.rate_pass,4) as rate_pass from (select pat.target_id , pat.month_salary from pipe_attendant pat) patt, (select count(*) as patrol_count, atpt.target_id from axiom_track_patrol atpt where atpt.gps_time between ? and ? group by atpt.target_id) atptt, (select count(*) as speed_count, aast.target_id from axiom_alarm_speed aast where aast.gps_time between ? and ? group by aast.target_id) aastt, (select count(*) as region_count, aart.target_id from axiom_alarm_region aart where aart.gps_time between ? and ? group by aart.target_id) aartt, (select count(*) as point_count, aapt.target_id from axiom_alarm_point aapt where aapt.gps_time between ? and ? group by aapt.target_id) aaptt, (select att.target_id, att.target_name from axiom_target att  where att.target_id in (select substr(?, s, e - s) from (select pos_start.pos as s, pos_end.pos as e from (select rownum rn, pos from (select distinct pos from (select instr(concat(',', ?),',', rownum) as pos from dual  connect by rownum <= length(?))  where pos > 0  order by pos)) pos_start,(select rownum rn, pos from (select distinct pos from (select instr(concat(?, ','), ',',  rownum) as pos from dual connect by rownum <= length(?)) where pos > 0 order by pos)) pos_end where pos_start.rn = pos_end.rn))) attt, (select target_id,  count(*) as day_pass,count(*)/(trunc((? - ?) / (24 * 60 * 60)) + 1) as rate_pass from (select target_id, gps_date , sign(sign( piont_count - 1) + sign(task_count) * -2) as total_pass from (select base.gps_date, base.target_id, nvl(patrol_count, 0) patrol_count, nvl(speed_count, 0) speed_count, nvl(region_count, 0) region_count, nvl(piont_count, 0) piont_count, nvl(task_count, 0) task_count from (select target_id, to_char(axiom_utc_to_date(trunc(gps_time / (24 * 60 * 60)) * (24 * 60 * 60)), 'yyyy-mm-dd') as gps_date,  count(*) as patrol_count from axiom_track_patrol where bitand(terminal_status, 16) = 16 and gps_time between ? and ? group by target_id, trunc(gps_time / (24 * 60 * 60))) patrol, (select target_id, to_char(axiom_utc_to_date(trunc(gps_time / (24 * 60 * 60)) * (24 * 60 * 60)), 'yyyy-mm-dd') as gps_date, count(gps_time) as speed_count from axiom_alarm_speed where gps_time between ? and ? group by target_id,trunc(gps_time / (24 * 60 * 60))) speed, (select target_id,to_char(axiom_utc_to_date(trunc(gps_time / (24 * 60 * 60)) * (24 * 60 * 60)), 'yyyy-mm-dd') as gps_date, count(gps_time) as region_count from axiom_alarm_region where gps_time between ? and ? group by target_id,trunc(gps_time / (24 * 60 * 60))) region,(select target_id,to_char
(axiom_utc_to_date(trunc(gps_time / (24 * 60 * 60)) * (24 * 60 * 60)), 'yyyy-mm-dd') as gps_date, count(gps_time) as piont_count from axiom_alarm_point where gps_time between ? and ? group by target_id,trunc(gps_time / (24 * 60 * 60))) point,(select target_id,to_char(axiom_utc_to_date(trunc(task_date / (24 * 60 * 60)) * (24 * 60 * 60)), 'yyyy-mm-dd') as task_date, count(task_date) as task_count from pipe_special_task where task_date between ? and ? group by target_id,trunc(task_date / (24 * 60 * 60))) task,(select target_id, gps_date from (select substr(?, s, e - s) target_id from (select pos_start.pos as s, pos_end.pos as e from (select rownum rn, pos from (select distinct pos from (select instr(concat(',', ?), ',',  rownum) as pos from dual connect by rownum <= length(?)) where pos > 0 order by pos)) pos_start, (select rownum rn, pos from (select distinct pos from (select instr(concat(?, ','), ',', rownum) as pos from dual connect by rownum <= length(?)) where pos > 0 order by pos)) pos_end where pos_start.rn = pos_end.rn)) target_base, (select to_char(axiom_utc_to_date((trunc(? / (24 * 60 * 60)) + rownum - 1) * (24 * 60 * 60)), 'yyyy-mm-dd') as gps_date from dual connect by rownum <= (trunc((? - ?) / (24 * 60 * 60)) + 1)) date_base) base where base.gps_date = patrol.gps_date(+) and base.gps_date = speed.gps_date(+) and base.gps_date = region.gps_date(+) and base.gps_date = point.gps_date(+) and base.gps_date = task.task_date(+) and base.target_id = patrol.target_id(+) and base.target_id = speed.target_id(+) and base.target_id = region.target_id(+) and base.target_id = point.target_id(+) and base.target_id = task.target_id(+) ) ) vtable where vtable.total_pass = -1 group by target_id ) salaryt where attt.target_id = patt.target_id(+) and attt.target_id = atptt.target_id(+) and attt.target_id = aastt.target_id(+) and attt.target_id = aartt.target_id(+) and attt.target_id = aaptt.target_id(+) and attt.target_id = salaryt.target_id(+))

sql.pipe.report_diy.report_matter.query.page =  main,select * from (select a.*,rownum row_num from (select to_char(axiom_utc_to_date(?), 'yyyy-mm-dd'), to_char(axiom_utc_to_date(?), 'yyyy-mm-dd'), attt.target_name, attt.target_id, nvl(atptt.patrol_count,0) patrol_count, nvl(aastt.speed_count,0) speed_count, nvl(aartt.region_count,0) region_count, nvl(aaptt.point_count,0) point_count, trunc(salaryt.day_pass * patt.month_salary / 30,2) as money,trunc(salaryt.rate_pass,4) as rate_pass from (select pat.target_id , pat.month_salary from pipe_attendant pat) patt, (select count(*) as patrol_count, atpt.target_id from axiom_track_patrol atpt where atpt.gps_time between ? and ? group by atpt.target_id) atptt, (select count(*) as speed_count, aast.target_id from axiom_alarm_speed aast where aast.gps_time between ? and ? group by aast.target_id) aastt, (select count(*) as region_count, aart.target_id from axiom_alarm_region aart where aart.gps_time between ? and ? group by aart.target_id) aartt, (select count(*) as point_count, aapt.target_id from axiom_alarm_point aapt where aapt.gps_time between ? and ? group by aapt.target_id) aaptt, (select att.target_id, att.target_name from axiom_target att  where att.target_id in (select substr(?, s, e - s) from (select pos_start.pos as s, pos_end.pos as e from (select rownum rn, pos from (select distinct pos from (select instr(concat(',', ?),',', rownum) as pos from dual  connect by rownum <= length(?))  where pos > 0  order by pos)) pos_start,(select rownum rn, pos from (select distinct pos from (select instr(concat(?, ','), ',',  rownum) as pos from dual connect by rownum <= length(?)) where pos > 0 order by pos)) pos_end where pos_start.rn = pos_end.rn))) attt, (select target_id,  count(*) as day_pass,count(*)/(trunc((? - ?) / (24 * 60 * 60)) + 1) as rate_pass from (select target_id, gps_date , sign(sign( piont_count - 1) + sign(task_count) * -2) as total_pass from (select base.gps_date, base.target_id, nvl(patrol_count, 0) patrol_count, nvl(speed_count, 0) speed_count, nvl(region_count, 0) region_count, nvl(piont_count, 0) piont_count, nvl(task_count, 0) task_count from (select target_id, to_char(axiom_utc_to_date(trunc(gps_time / (24 * 60 * 60)) * (24 * 60 * 60)), 'yyyy-mm-dd') as gps_date,  count(*) as patrol_count from axiom_track_patrol where bitand(terminal_status, 16) = 16 and gps_time between ? and ? group by target_id, trunc(gps_time / (24 * 60 * 60))) patrol, (select target_id, to_char(axiom_utc_to_date(trunc(gps_time / (24 * 60 * 60)) * (24 * 60 * 60)), 'yyyy-mm-dd') as gps_date, count(gps_time) as speed_count from axiom_alarm_speed where gps_time between ? and ? group by target_id,trunc(gps_time / (24 * 60 * 60))) speed, (select 
target_id,to_char(axiom_utc_to_date(trunc(gps_time / (24 * 60 * 60)) * (24 * 60 * 60)), 'yyyy-mm-dd') as gps_date, count(gps_time) as region_count from axiom_alarm_region where gps_time between ? and ? group by target_id,trunc(gps_time / (24 * 60 * 60))) region,(select target_id,to_char(axiom_utc_to_date(trunc(gps_time / (24 * 60 * 60)) * (24 * 60 * 60)), 'yyyy-mm-dd') as gps_date, count(gps_time) as piont_count from axiom_alarm_point where gps_time between ? and ? group by target_id,trunc(gps_time / (24 * 60 * 60))) point,(select target_id,to_char(axiom_utc_to_date(trunc(task_date / (24 * 60 * 60)) * (24 * 60 * 60)), 'yyyy-mm-dd') as task_date, count(task_date) as task_count from pipe_special_task where task_date between ? and ? group by target_id,trunc(task_date / (24 * 60 * 60))) task,(select target_id, gps_date from (select substr(?, s, e - s) target_id from (select pos_start.pos as s, pos_end.pos as e from (select rownum rn, pos from (select distinct pos from (select instr(concat(',', ?), ',',  rownum) as pos from dual connect by rownum <= length(?)) where pos > 0 order by pos)) pos_start, (select rownum rn, pos from (select distinct pos from (select instr(concat(?, ','), ',', rownum) as pos from dual connect by rownum <= length(?)) where pos > 0 order by pos)) pos_end where pos_start.rn = pos_end.rn)) target_base, (select to_char(axiom_utc_to_date((trunc(? / (24 * 60 * 60)) + rownum - 1) * (24 * 60 * 60)), 'yyyy-mm-dd') as gps_date from dual connect by rownum <= (trunc((? - ?) / (24 * 60 * 60)) + 1)) date_base) base where base.gps_date = patrol.gps_date(+) and base.gps_date = speed.gps_date(+) and base.gps_date = region.gps_date(+) and base.gps_date = point.gps_date(+) and base.gps_date = task.task_date(+) and base.target_id = patrol.target_id(+) and base.target_id = speed.target_id(+) and base.target_id = region.target_id(+) and base.target_id = point.target_id(+) and base.target_id = task.target_id(+) ) ) vtable where vtable.total_pass = -1 group by target_id ) salaryt where attt.target_id = patt.target_id(+) and attt.target_id = atptt.target_id(+) and attt.target_id = aastt.target_id(+) and attt.target_id = aartt.target_id(+) and attt.target_id = aaptt.target_id(+) and attt.target_id = salaryt.target_id(+) order by  attt.target_name)a ) b where  b.row_num between ? and ?

sql.pipe.report_diy.report_matter_all.query =  main,select to_char(axiom_utc_to_date(?), 'yyyy-mm-dd'), to_char(axiom_utc_to_date(?), 'yyyy-mm-dd'), attt.target_name, attt.target_id, nvl(atptt.patrol_count,0) patrol_count, nvl(aastt.speed_count,0) speed_count, nvl(aartt.region_count,0) region_count, nvl(aaptt.point_count,0) point_count, trunc(salaryt.day_pass * patt.month_salary / 30,2) as money,trunc(salaryt.rate_pass,4) from (select pat.target_id , pat.month_salary from pipe_attendant pat) patt, (select count(*) as patrol_count, atpt.target_id from axiom_track_patrol atpt where atpt.gps_time between ? and ? group by atpt.target_id) atptt, (select count(*) as speed_count, aast.target_id from axiom_alarm_speed aast where aast.gps_time between ? and ? group by aast.target_id) aastt, (select count(*) as region_count, aart.target_id from axiom_alarm_region aart where aart.gps_time between ? and ? group by aart.target_id) aartt, (select count(*) as point_count, aapt.target_id from axiom_alarm_point aapt where aapt.gps_time between ? and ? group by aapt.target_id) aaptt, (select att.target_id, att.target_name from axiom_target att  where att.target_id in (select substr(?, s, e - s) from (select pos_start.pos as s, pos_end.pos as e from (select rownum rn, pos from (select distinct pos from (select instr(concat(',', ?),',', rownum) as pos from dual  connect by rownum <= length(?))  where pos > 0  order by pos)) pos_start,(select rownum rn, pos from (select distinct pos from (select instr(concat(?, ','), ',',  rownum) as pos from dual connect by rownum <= length(?)) where pos > 0 order by pos)) pos_end where pos_start.rn = pos_end.rn))) attt, (select target_id,  count(*) as day_pass,count(*)/(trunc((? - ?) / (24 * 60 * 60)) + 1) as rate_pass from (select target_id, gps_date , sign(sign( piont_count - 1) + sign(task_count) * -2) as total_pass from (select base.gps_date, base.target_id, nvl(patrol_count, 0) patrol_count, nvl(speed_count, 0) speed_count, nvl(region_count, 0) region_count, nvl(piont_count, 0) piont_count, nvl(task_count, 0) task_count from (select target_id, to_char(axiom_utc_to_date(trunc(gps_time / (24 * 60 * 60)) * (24 * 60 * 60)), 'yyyy-mm-dd') as gps_date,  count(*) as patrol_count from axiom_track_patrol where bitand(terminal_status, 16) = 16 and gps_time between ? and ? group by target_id, trunc(gps_time / (24 * 60 * 60))) patrol, (select target_id, to_char(axiom_utc_to_date(trunc(gps_time / (24 * 60 * 60)) * (24 * 60 * 60)), 'yyyy-mm-dd') as gps_date, count(gps_time) as speed_count from axiom_alarm_speed where gps_time between ? and ? group by 
target_id,trunc(gps_time / (24 * 60 * 60))) speed, (select target_id,to_char(axiom_utc_to_date(trunc(gps_time / (24 * 60 * 60)) * (24 * 60 * 60)), 'yyyy-mm-dd') as gps_date, count(gps_time) as region_count from axiom_alarm_region where gps_time between ? and ? group by target_id,trunc(gps_time / (24 * 60 * 60))) region,(select target_id,to_char(axiom_utc_to_date(trunc(gps_time / (24 * 60 * 60)) * (24 * 60 * 60)), 'yyyy-mm-dd') as gps_date, count(gps_time) as piont_count from axiom_alarm_point where gps_time between ? and ? group by target_id,trunc(gps_time / (24 * 60 * 60))) point,(select target_id,to_char(axiom_utc_to_date(trunc(task_date / (24 * 60 * 60)) * (24 * 60 * 60)), 'yyyy-mm-dd') as task_date, count(task_date) as task_count from pipe_special_task where task_date between ? and ? group by target_id,trunc(task_date / (24 * 60 * 60))) task,(select target_id, gps_date from (select substr(?, s, e - s) target_id from (select pos_start.pos as s, pos_end.pos as e from (select rownum rn, pos from (select distinct pos from (select instr(concat(',', ?), ',',  rownum) as pos from dual connect by rownum <= length(?)) where pos > 0 order by pos)) pos_start, (select rownum rn, pos from (select distinct pos from (select instr(concat(?, ','), ',', rownum) as pos from dual connect by rownum <= length(?)) where pos > 0 order by pos)) pos_end where pos_start.rn = pos_end.rn)) target_base, (select to_char(axiom_utc_to_date((trunc(? / (24 * 60 * 60)) + rownum - 1) * (24 * 60 * 60)), 'yyyy-mm-dd') as gps_date from dual connect by rownum <= (trunc((? - ?) / (24 * 60 * 60)) + 1)) date_base) base where base.gps_date = patrol.gps_date(+) and base.gps_date = speed.gps_date(+) and base.gps_date = region.gps_date(+) and base.gps_date = point.gps_date(+) and base.gps_date = task.task_date(+) and base.target_id = patrol.target_id(+) and base.target_id = speed.target_id(+) and base.target_id = region.target_id(+) and base.target_id = point.target_id(+) and base.target_id = task.target_id(+) ) ) vtable where vtable.total_pass = -1 group by target_id ) salaryt where attt.target_id = patt.target_id(+) and attt.target_id = atptt.target_id(+) and attt.target_id = aastt.target_id(+) and attt.target_id = aartt.target_id(+) and attt.target_id = aaptt.target_id(+) and attt.target_id = salaryt.target_id(+)


// 手机报表整理 合并
sql.patrol.report.total = 1,2,1,2,1,2,1,2,1,2,1,1,2,2,1,1,2,1,2,1,2,1,2,1,2,1,2,1>patrol.report.total
sql.patrol.report.total =  main,select attt.target_name, nvl(atptt.patrol_count,0) patrol_count,  nvl(aastt.speed_count,0) speed_count,  nvl(aartt.region_count,0) region_count, nvl(aaptt.point_count,0) point_count, nvl(trunc(salaryt.rate_pass,4),0) as rate_pass  from  (select pat.target_id ,  pat.month_salary from pipe_attendant pat) patt,  (select count(*) as patrol_count,  atpt.target_id from axiom_track_patrol atpt  where atpt.gps_time between ? and ? group by atpt.target_id) atptt,  (select count(*) as speed_count, aast.target_id  from axiom_alarm_speed aast where aast.gps_time between ? and ?  group by aast.target_id) aastt,   (select count(*) as region_count, aart.target_id  from axiom_alarm_region aart where aart.gps_time between ? and ?  group by aart.target_id) aartt,  (select  target_id , sum(leak_piont_count) as point_count from( select  base.target_id, nvl(t_point_count - piont_count, t_point_count) as leak_piont_count from   (select target_id, gps_date,count(gps_date) as piont_count from( select target_id,to_char(trunc(axiom_utc_to_date(gps_time)), 'yyyy-mm-dd') as gps_date, point_id from axiom_alarm_point where gps_time  between ? and ?  group by target_id,trunc(axiom_utc_to_date(gps_time)),point_id ) group by target_id,gps_date ) point, (select target_id, gps_date from ( select ut.target_id from (select target_id, group_id, target_name,terminal_id  from (select at.target_id, t.group_id, at.target_name,  at.terminal_id from axiom_target at,  (select target_id, group_id from axiom_group_target where group_id in (select group_id from axiom_group where corp_id in (select corp_id from axiom_corp start with corp_id = (select corp_id from axiom_user where user_id = 65 and status = 1) connect by prior corp_id = parent_id))) t where at.target_id = t.target_id union select att.target_id, agt.group_id, att.target_name, att.terminal_id from axiom_target att, axiom_group_target agt, axiom_user_group aug where agt.target_id = att.target_id and agt.group_id = aug.group_id and aug.user_id = 65) order by target_name) ut, axiom_terminal atm, axiom_terminal_type atmt where  ut.terminal_id = atm.terminal_id and atm.terminal_type_id = atmt.terminal_type_id  and atmt.identity = 'gpstracker' UNION select ut.target_id from (select t.target_id, t.corp_id, t.target_name, t.terminal_id from (select target_id, corp_id, target_name, terminal_id from axiom_target where corp_id in (select corp_id from axiom_corp start with corp_id = 84 connect by prior corp_id = parent_id)) t where t.target_id not in (select target_id from axiom_group_target) order by t.target_name) ut, axiom_terminal atm, axiom_terminal_type atmt where  ut.terminal_id = atm.terminal_id and atm.terminal_type_id = atmt.terminal_type_id and atmt.identity = 'gpstracker' ) target_base, (select to_char(axiom_utc_to_date((trunc(? / (24 * 60 * 60)) + rownum ) * (24 * 60 * 60)), 'yyyy-mm-dd') as gps_date from dual connect by rownum <= (trunc((? - ?) / (24 * 60 * 60)) + 1)) date_base order by target_id ) base , (select count(point_id)as t_point_count,target_id from axiom_analyze_target_point group by target_id ) target_point  where base.gps_date = point.gps_date(+) and base.target_id = point.target_id(+)  and base.target_id = target_point.target_id(+) ) group by target_id  ) aaptt , (select target_id, count(task_date) as task_count from pipe_special_task where task_date between ? and ? group by target_id,trunc(axiom_utc_to_date(task_date)) ) task, (select att.target_id, att.target_name  from axiom_target att  ,( select ut.target_id from (select target_id, group_id, target_name,terminal_id  from (select at.target_id, t.group_id, at.target_name,  at.terminal_id from axiom_target at,  (select target_id, group_id from axiom_group_target  where group_id in (select group_id from axiom_group where corp_id in (select corp_id from axiom_corp start with corp_id = (select corp_id from axiom_user where user_id = 65 and status = 1) connect by prior corp_id = parent_id))) t where at.target_id = t.target_id union select att.target_id, agt.group_id, att.target_name, att.terminal_id from axiom_target att, axiom_group_target agt, axiom_user_group aug where agt.target_id = att.target_id and agt.group_id = aug.group_id and aug.user_id = 65) order by target_name) ut, axiom_terminal atm, axiom_terminal_type atmt where  ut.terminal_id = atm.terminal_id and atm.terminal_type_id = atmt.terminal_type_id and atmt.identity = 'gpstracker'  UNION select ut.target_id from (select t.target_id, t.corp_id, t.target_name, t.terminal_id from (select target_id, corp_id, target_name, terminal_id from axiom_target where corp_id in (select corp_id from axiom_corp start with corp_id = 84 connect by prior corp_id = parent_id)) t where t.target_id not in (select target_id from axiom_group_target) order by t.target_name) ut, axiom_terminal atm, axiom_terminal_type atmt where  ut.terminal_id = atm.terminal_id and atm.terminal_type_id = atmt.terminal_type_id and atmt.identity = 'gpstracker'  ) at_ where att.target_id = at_.target_id order by att.target_id ) attt,  (select target_id,  count(*)  as day_pass,(count(*)/(trunc((? - ?) / (24 * 60 * 60)) + 1))*100 as rate_pass  from (select gps_date, target_id, leak_piont_count, task_count, sign(sign(leak_piont_count * 2 - 1) + sign(task_count) * -2) total_pass from (select base.gps_date, base.target_id, nvl(piont_count, 0) piont_count, nvl(task_count, 0) task_count, nvl(t_point_count, 0) t_point_count , nvl(t_point_count - piont_count, t_point_count) leak_piont_count   from (select target_id, to_char(trunc(axiom_utc_to_date(gps_time)), 'yyyy-mm-dd') as gps_date,  count(*) as patrol_count from axiom_track_patrol where bitand(terminal_status, 16) = 16 and gps_time between ? and ? group by target_id, trunc(axiom_utc_to_date(gps_time))) patrol,  (select target_id, to_char(trunc(axiom_utc_to_date(gps_time)), 'yyyy-mm-dd') as gps_date, count(gps_time) as speed_count from axiom_alarm_speed where gps_time between ? and ? group by target_id,trunc(axiom_utc_to_date(gps_time))) speed,  (select target_id,to_char(trunc(axiom_utc_to_date(gps_time)), 'yyyy-mm-dd') as gps_date, count(gps_time) as region_count from axiom_alarm_region where gps_time between ? and ? group by target_id,trunc(axiom_utc_to_date(gps_time))) region, (select target_id, gps_date,count(gps_date) as piont_count from( select target_id,to_char(trunc(axiom_utc_to_date(gps_time)), 'yyyy-mm-dd') as gps_date, point_id from axiom_alarm_point where gps_time  between ? and ?  group by target_id,trunc(axiom_utc_to_date(gps_time)),point_id ) group by target_id,gps_date ) point, (select target_id,to_char(trunc(axiom_utc_to_date(task_date)), 'yyyy-mm-dd') as task_date, count(task_date) as task_count from pipe_special_task where task_date between ? and ? group by target_id,trunc(axiom_utc_to_date(task_date)) ) task,  (select  target_id, gps_date from ( select ut.target_id from (select target_id, group_id, target_name,terminal_id  from (select at.target_id, t.group_id, at.target_name,  at.terminal_id from axiom_target at,  (select target_id, group_id from axiom_group_target where group_id in (select group_id from axiom_group where corp_id in (select corp_id from axiom_corp start with corp_id = (select corp_id from axiom_user where user_id = 65 and status = 1) connect by prior corp_id = parent_id))) t where at.target_id = t.target_id union select att.target_id, agt.group_id, att.target_name, att.terminal_id from axiom_target att, axiom_group_target agt, axiom_user_group aug where agt.target_id = att.target_id and agt.group_id = aug.group_id and aug.user_id = 65) order by target_name) ut, axiom_terminal atm, axiom_terminal_type atmt where  ut.terminal_id = atm.terminal_id and atm.terminal_type_id = atmt.terminal_type_id UNION select ut.target_id from (select t.target_id, t.corp_id, t.target_name, t.terminal_id from (select target_id, corp_id, target_name, terminal_id from axiom_target where corp_id in (select corp_id from axiom_corp start with corp_id = 84 connect by prior corp_id = parent_id)) t where t.target_id not in (select target_id from axiom_group_target) order by t.target_name) ut, axiom_terminal atm, axiom_terminal_type atmt where  ut.terminal_id = atm.terminal_id and atm.terminal_type_id = atmt.terminal_type_id ) target_base, (select to_char(axiom_utc_to_date((trunc(? / (24 * 60 * 60)) + rownum ) * (24 * 60 * 60)), 'yyyy-mm-dd') as gps_date from dual connect by rownum <= (trunc((? - ?) / (24 * 60 * 60)) + 1)) date_base order by target_id ) base , (select count(point_id)as t_point_count,target_id from axiom_analyze_target_point group by target_id ) target_point where base.gps_date = patrol.gps_date(+)  and base.gps_date = speed.gps_date(+)  and base.gps_date = region.gps_date(+)  and base.gps_date = point.gps_date(+)   and base.gps_date = task.task_date(+)   and base.target_id = patrol.target_id(+)  and base.target_id = speed.target_id(+)  and base.target_id = region.target_id(+)  and base.target_id = point.target_id(+)   and base.target_id = task.target_id(+)  and base.target_id = target_point.target_id(+)  ) order by target_id, gps_date )  vtable  where vtable.total_pass = -1 group by target_id ) salaryt  where attt.target_id = patt.target_id(+)  and attt.target_id = atptt.target_id(+)  and attt.target_id = aastt.target_id(+)  and attt.target_id = aartt.target_id(+)  and attt.target_id = aaptt.target_id(+)  and attt.target_id = salaryt.target_id(+)  and attt.target_id = task.target_id(+)  order by  attt.target_name 


//web 报表整理
sql.pipe.report_diy.report_matter.select = 1,2,1,2,1,2,1,2,1,2,3,3,3,3,3,1,2,1,1,2,3,3,3,3,3,2,1,1,2,1,2,1,2,1,2,1,2,3,3,3,3,3,1,2,1>pipe.report_diy.report_matter.select
sql.pipe.report_diy.report_matter.select =  main,select to_char(axiom_utc_to_date(?), 'yyyy-mm-dd') as s_date, to_char(axiom_utc_to_date(?), 'yyyy-mm-dd') as e_date,  attt.target_name,  attt.target_id,  nvl(atptt.patrol_count,0) patrol_count,  nvl(aastt.speed_count,0) speed_count,  nvl(aartt.region_count,0) region_count, nvl(aaptt.point_count,0) point_count,  nvl(task.task_count,0) task_count,  trunc(salaryt.day_pass * patt.month_salary / 30,2) as money, trunc(salaryt.rate_pass,4) as rate_pass  from (select pat.target_id ,  pat.month_salary from pipe_attendant pat) patt,  (select count(*) as patrol_count,  atpt.target_id from axiom_track_patrol atpt  where atpt.gps_time between ? and ? group by atpt.target_id) atptt,  (select count(*) as speed_count, aast.target_id  from axiom_alarm_speed aast where aast.gps_time between ? and ?  group by aast.target_id) aastt,   (select count(*) as region_count, aart.target_id  from axiom_alarm_region aart where aart.gps_time between ? and ?  group by aart.target_id) aartt,  (select  target_id , sum(leak_piont_count) as point_count from( select  base.target_id, nvl(t_point_count - piont_count, t_point_count) as leak_piont_count from   ( select target_id, gps_date,count(gps_date) as piont_count from( select target_id,to_char(trunc(axiom_utc_to_date(gps_time)), 'yyyy-mm-dd') as gps_date, point_id from axiom_alarm_point where gps_time  between ? and ?  group by target_id,trunc(axiom_utc_to_date(gps_time)),point_id ) group by target_id,gps_date ) point,  (select target_id, gps_date from (select substr(?, s, e - s) target_id from (select pos_start.pos as s, pos_end.pos as e from (select rownum rn, pos from (select distinct pos from (select instr(concat(',', ?), ',',  rownum) as pos from dual connect by rownum <= length(?)) where pos > 0 order by pos)) pos_start,  (select rownum rn, pos from (select distinct pos from (select instr(concat(?, ','), ',', rownum) as pos from dual connect by rownum <= length(?)) where pos > 0 order by pos)) pos_end where pos_start.rn = pos_end.rn)) target_base,  (select to_char(axiom_utc_to_date((trunc(? / (24 * 60 * 60)) + rownum ) * (24 * 60 * 60)), 'yyyy-mm-dd') as gps_date from dual connect by rownum <= (trunc((? - ?) / (24 * 60 * 60)) + 1)) date_base) base ,  (select count(point_id)as t_point_count,target_id from axiom_analyze_target_point group by target_id ) target_point  where base.gps_date = point.gps_date(+) and base.target_id = point.target_id(+)  and base.target_id = target_point.target_id(+) ) group by target_id ) aaptt , (select target_id, count(task_date) as task_count from pipe_special_task where task_date between ? and ? group by target_id,trunc(axiom_utc_to_date(task_date)) ) task, (select att.target_id, att.target_name  from axiom_target att  where att.target_id in (select substr(?, s, e - s)  from (select pos_start.pos as s, pos_end.pos as e from  (select rownum rn, pos from (select distinct pos from  (select instr(concat(',', ?),',', rownum) as pos from dual  connect by rownum <= length(?))  where pos > 0  order by pos)) pos_start, (select rownum rn, pos from (select distinct pos  from (select instr(concat(?, ','), ',',  rownum) as pos from dual  connect by rownum <= length(?)) where pos > 0 order by pos)) pos_end  where pos_start.rn = pos_end.rn))) attt,   (select target_id,  count(*)  as day_pass,count(*)/(trunc((? - ?) / (24 * 60 * 60)) + 1) as rate_pass   from (select gps_date, target_id, leak_piont_count, task_count, sign(sign(leak_piont_count * 2 - 1) + sign(task_count) * -2) total_pass  from( select base.gps_date, base.target_id, nvl(piont_count, 0) piont_count, nvl(task_count, 0) task_count, nvl(t_point_count, 0) t_point_count , nvl(t_point_count - piont_count, t_point_count) leak_piont_count from   (select target_id, to_char(trunc(axiom_utc_to_date(gps_time)), 'yyyy-mm-dd') as gps_date,  count(*) as patrol_count from axiom_track_patrol where bitand(terminal_status, 16) = 16 and gps_time between ? and ? group by target_id, trunc(axiom_utc_to_date(gps_time))) patrol,    (select target_id, to_char(trunc(axiom_utc_to_date(gps_time)), 'yyyy-mm-dd') as gps_date, count(gps_time) as speed_count from axiom_alarm_speed where gps_time between ? and ? group by target_id,trunc(axiom_utc_to_date(gps_time))) speed,   (select target_id,to_char(trunc(axiom_utc_to_date(gps_time)), 'yyyy-mm-dd') as gps_date, count(gps_time) as region_count from axiom_alarm_region where gps_time between ? and ? group by target_id,trunc(axiom_utc_to_date(gps_time))) region,  ( select target_id, gps_date,count(gps_date) as piont_count from( select target_id,to_char(trunc(axiom_utc_to_date(gps_time)), 'yyyy-mm-dd') as gps_date, point_id from axiom_alarm_point where gps_time  between ? and ?  group by target_id,trunc(axiom_utc_to_date(gps_time)),point_id ) group by target_id,gps_date ) point, (select target_id,to_char(trunc(axiom_utc_to_date(task_date)), 'yyyy-mm-dd') as task_date, count(task_date) as task_count from pipe_special_task where task_date between ? and ? group by target_id,trunc(axiom_utc_to_date(task_date)) ) task,  (select target_id, gps_date from (select substr(?, s, e - s) target_id from (select pos_start.pos as s, pos_end.pos as e from (select rownum rn, pos from (select distinct pos from (select instr(concat(',', ?), ',',  rownum) as pos from dual connect by rownum <= length(?)) where pos > 0 order by pos)) pos_start,  (select rownum rn, pos from (select distinct pos from (select instr(concat(?, ','), ',', rownum) as pos from dual connect by rownum <= length(?)) where pos > 0 order by pos)) pos_end where pos_start.rn = pos_end.rn)) target_base,  (select to_char(axiom_utc_to_date((trunc(? / (24 * 60 * 60)) + rownum ) * (24 * 60 * 60)), 'yyyy-mm-dd') as gps_date from dual connect by rownum <= (trunc((? - ?) / (24 * 60 * 60)) + 1)) date_base) base , (select count(point_id)as t_point_count,target_id from axiom_analyze_target_point group by target_id ) target_point  where base.gps_date = patrol.gps_date(+)  and base.gps_date = speed.gps_date(+)  and base.gps_date = region.gps_date(+)  and base.gps_date = point.gps_date(+)   and base.gps_date = task.task_date(+)   and base.target_id = patrol.target_id(+)  and base.target_id = speed.target_id(+)  and base.target_id = region.target_id(+)  and base.target_id = point.target_id(+)   and base.target_id = task.target_id(+)  and base.target_id = target_point.target_id(+)  ) order by target_id, gps_date )  vtable  where vtable.total_pass = -1 group by target_id  ) salaryt   where attt.target_id = patt.target_id(+)  and attt.target_id = atptt.target_id(+)  and attt.target_id = aastt.target_id(+)  and attt.target_id = aartt.target_id(+)  and attt.target_id = aaptt.target_id(+)  and attt.target_id = salaryt.target_id(+)  and attt.target_id = task.target_id(+)  order by  attt.target_name 


//最新


sql.pipe.report_diy.report_matter.select =  1,2,1,2,1,2,1,2,1,2,3,3,3,3,3,1,2,1,1,2,3,3,3,3,3,1,2,1,1,2,3,3,3,3,3,2,1,1,2,1,2,1,2,1,2,1,2,3,3,3,3,3,1,2,1>pipe.report_diy.report_matter.select

sql.pipe.report_diy.report_matter.select =  main,select to_char(axiom_utc_to_date(?), 'yyyy-mm-dd') as s_date, to_char(axiom_utc_to_date(?), 'yyyy-mm-dd') as e_date,  attt.target_name,  attt.target_id,  nvl(atptt.patrol_count,0) patrol_count,  nvl(aastt.speed_count,0) speed_count,  nvl(aartt.region_count,0) region_count,point_count_total, nvl(aaptt.point_count,0) point_count,  nvl(task.task_count,0) task_count,  trunc(salaryt.day_pass * patt.month_salary / 30,2) as money, trunc(salaryt.rate_pass,4) as rate_pass  from (select pat.target_id ,  pat.month_salary from pipe_attendant pat) patt,  (select count(*) as patrol_count,  atpt.target_id from axiom_track_patrol atpt  where atpt.gps_time between ? and ? group by atpt.target_id) atptt,  (select count(*) as speed_count, aast.target_id  from axiom_alarm_speed aast where aast.gps_time between ? and ?  group by aast.target_id) aastt,   (select count(*) as region_count, aart.target_id  from axiom_alarm_region aart where aart.gps_time between ? and ?  group by aart.target_id) aartt,(select target_id , sum(leak_piont_count) as point_count_total from( select base.target_id, trunc(nvl(t_point_count - piont_count, t_point_count)/t_point_count) as leak_piont_count from (select target_id, gps_date,count(gps_date) as piont_count from( select target_id,to_char(trunc(axiom_utc_to_date(gps_time)), 'yyyy-mm-dd') as gps_date, point_id from axiom_alarm_point where gps_time  between ? and ?  group by target_id,trunc(axiom_utc_to_date(gps_time)),point_id ) group by target_id,gps_date ) point, (select target_id, gps_date from (select substr(?, s, e - s) target_id from (select pos_start.pos as s, pos_end.pos as e from (select rownum rn, pos from  (select distinct pos from (select instr(concat(',', ?), ',',  rownum) as pos from dual connect by rownum <= length(?)) where pos > 0 order by pos)) pos_start,   (select rownum rn, pos from (select distinct pos from (select instr(concat(?, ','), ',', rownum) as pos from dual connect by rownum <= length(?)) where pos > 0 order by pos)) pos_end where pos_start.rn = pos_end.rn)) target_base,   (select to_char(axiom_utc_to_date((trunc(? / (24 * 60 * 60)) + rownum) * (24 * 60 * 60)), 'yyyy-mm-dd') as gps_date from dual connect by rownum <= (trunc((? - ?) / (24 * 60 * 60)) + 1)) date_base) base , (select count(point_id)as t_point_count,target_id from axiom_analyze_target_point group by target_id ) target_point  where base.gps_date = point.gps_date(+) and base.target_id = point.target_id(+)  and base.target_id = target_point.target_id(+) ) group by target_id ) tpc,  (select  target_id , sum(leak_piont_count) as point_count from( select  base.target_id, nvl(t_point_count - piont_count, t_point_count) as leak_piont_count from   ( select target_id, gps_date,count(gps_date) as piont_count from( select target_id,to_char(trunc(axiom_utc_to_date(gps_time)), 'yyyy-mm-dd') as gps_date, point_id from axiom_alarm_point where gps_time  between ? and ?  group by target_id,trunc(axiom_utc_to_date(gps_time)),point_id ) group by target_id,gps_date ) point,  (select target_id, gps_date from (select substr(?, s, e - s) target_id from (select pos_start.pos as s, pos_end.pos as e from (select rownum rn, pos from (select distinct pos from (select instr(concat(',', ?), ',',  rownum) as pos from dual connect by rownum <= length(?)) where pos > 0 order by pos)) pos_start,  (select rownum rn, pos from (select distinct pos from (select instr(concat(?, ','), ',', rownum) as pos from dual connect by rownum <= length(?)) where pos > 0 order by pos)) pos_end where pos_start.rn = pos_end.rn)) target_base,  (select to_char(axiom_utc_to_date((trunc(? / (24 * 60 * 60)) + rownum ) * (24 * 60 * 60)), 'yyyy-mm-dd') as gps_date from dual connect by rownum <= (trunc((? - ?) / (24 * 60 * 60)) + 1)) date_base) base ,  (select count(point_id)as t_point_count,target_id from axiom_analyze_target_point group by target_id ) target_point  where base.gps_date = point.gps_date(+) and base.target_id = point.target_id(+)  and base.target_id = target_point.target_id(+) ) group by target_id ) aaptt , (select target_id, count(task_date) as task_count from pipe_special_task where task_date between ? and ? group by target_id,trunc(axiom_utc_to_date(task_date)) ) task, (select att.target_id, att.target_name  from axiom_target att  where att.target_id in (select substr(?, s, e - s)  from (select pos_start.pos as s, pos_end.pos as e from  (select rownum rn, pos from (select distinct pos from  (select instr(concat(',', ?),',', rownum) as pos from dual  connect by rownum <= length(?))  where pos > 0  order by pos)) pos_start, (select rownum rn, pos from (select distinct pos  from (select instr(concat(?, ','), ',',  rownum) as pos from dual  connect by rownum <= length(?)) where pos > 0 order by pos)) pos_end  where pos_start.rn = pos_end.rn))) attt,   (select target_id,  count(*)  as day_pass,count(*)/(trunc((? - ?) / (24 * 60 * 60)) + 1) as rate_pass   from (select gps_date, target_id, leak_piont_count, task_count, sign(sign(leak_piont_count * 2 - 1) + sign(task_count) * -2) total_pass  from( select base.gps_date, base.target_id, nvl(piont_count, 0) piont_count, nvl(task_count, 0) task_count, nvl(t_point_count, 0) t_point_count , nvl(t_point_count - piont_count, t_point_count) leak_piont_count from   (select target_id, to_char(trunc(axiom_utc_to_date(gps_time)), 'yyyy-mm-dd') as gps_date,  count(*) as patrol_count from axiom_track_patrol where bitand(terminal_status, 16) = 16 and gps_time between ? and ? group by target_id, trunc(axiom_utc_to_date(gps_time))) patrol,    (select target_id, to_char(trunc(axiom_utc_to_date(gps_time)), 'yyyy-mm-dd') as gps_date, count(gps_time) as speed_count from axiom_alarm_speed where gps_time between ? and ? group by target_id,trunc(axiom_utc_to_date(gps_time))) speed,   (select target_id,to_char(trunc(axiom_utc_to_date(gps_time)), 'yyyy-mm-dd') as gps_date, count(gps_time) as region_count from axiom_alarm_region where gps_time between ? and ? group by target_id,trunc(axiom_utc_to_date(gps_time))) region,  ( select target_id, gps_date,count(gps_date) as piont_count from( select target_id,to_char(trunc(axiom_utc_to_date(gps_time)), 'yyyy-mm-dd') as gps_date, point_id from axiom_alarm_point where gps_time  between ? and ?  group by target_id,trunc(axiom_utc_to_date(gps_time)),point_id ) group by target_id,gps_date ) point, (select target_id,to_char(trunc(axiom_utc_to_date(task_date)), 'yyyy-mm-dd') as task_date, count(task_date) as task_count from pipe_special_task where task_date between ? and ? group by target_id,trunc(axiom_utc_to_date(task_date)) ) task,  (select target_id, gps_date from (select substr(?, s, e - s) target_id from (select pos_start.pos as s, pos_end.pos as e from (select rownum rn, pos from (select distinct pos from (select instr(concat(',', ?), ',',  rownum) as pos from dual connect by rownum <= length(?)) where pos > 0 order by pos)) pos_start,  (select rownum rn, pos from (select distinct pos from (select instr(concat(?, ','), ',', rownum) as pos from dual connect by rownum <= length(?)) where pos > 0 order by pos)) pos_end where pos_start.rn = pos_end.rn)) target_base,  (select to_char(axiom_utc_to_date((trunc(? / (24 * 60 * 60)) + rownum ) * (24 * 60 * 60)), 'yyyy-mm-dd') as gps_date from dual connect by rownum <= (trunc((? - ?) / (24 * 60 * 60)) + 1)) date_base) base , (select count(point_id)as t_point_count,target_id from axiom_analyze_target_point group by target_id ) target_point  where base.gps_date = patrol.gps_date(+)  and base.gps_date = speed.gps_date(+)  and base.gps_date = region.gps_date(+)  and base.gps_date = point.gps_date(+)   and base.gps_date = task.task_date(+)   and base.target_id = patrol.target_id(+)  and base.target_id = speed.target_id(+)  and base.target_id = region.target_id(+)  and base.target_id = point.target_id(+)   and base.target_id = task.target_id(+)  and base.target_id = target_point.target_id(+)  ) order by target_id, gps_date )  vtable  where vtable.total_pass = -1 group by target_id  ) salaryt   where attt.target_id = patt.target_id(+)  and attt.target_id = atptt.target_id(+)  and attt.target_id = aastt.target_id(+)  and attt.target_id = aartt.target_id(+)  and attt.target_id = aaptt.target_id(+)  and attt.target_id = salaryt.target_id(+)  and attt.target_id = task.target_id(+) and attt.target_id = tpc.target_id(+) order by  attt.target_name 


http://58.22.104.17:8005/db/c323fa3f66714b4eb0aab5112ae7388d/patrol.report.total/%5B1283702400%2C1283788799%5D?_dc=1283684753568&callback=stcCallback1006
http://localhost:8080/db/98fb14188c4140278d0d976a5a72448a/patrol.report.total/%5B1283270400%2C1284134399%5D?_dc=1283684753568&callback=stcCallback1006

http.report
report.pipe.report_diy.report_matter.select.head =  集体报表,开始日期, 结束日期 ,巡线员, 事件上报, 超速报警, 越界报警, 巡漏报警 ,特殊任务, 合格率(%) ,实发工资(￥)
report.pipe.report_diy.report_matter.select.sql =  main,select * from table(axiom_report_matter(?,?,?))


存储过程

create or replace function axiom_report_matter(target_id_val in varchar2, s_time in number,e_time in number) return report_matter_query PIPELINED IS
 TYPE myCursor IS REF CURSOR;  
  R myCursor;

  v_s_date varchar2(20);
  v_e_date varchar2(20);
  v_target_name varchar2(40);
  v_patrol_count number(10);
  v_speed_count  number(10);
  v_region_count number(10);
  v_point_count  number(10);
  v_task_count number(10);
  v_rate_pass number(10,4);
  v_money number(10,2);
  target_name_count number(10);
  patrol_count number(10);
  speed_count  number(10);
  region_count number(10);
  point_count  number(10);
  task_count number(10);
  rate_pass number(10,4);
  money number(10,2);
  
begin
    target_name_count:=0;
    patrol_count:=0;
    speed_count:=0;
    region_count:=0;
    point_count:=0;
    task_count:=0;
    rate_pass :=0.00;
    money :=0.00;
  
OPEN R FOR select 
 to_char(axiom_utc_to_date(s_time), 'yyyy-mm-dd') as s_date,
 to_char(axiom_utc_to_date(e_time), 'yyyy-mm-dd') as e_date, 
 attt.target_name,  nvl(atptt.patrol_count,0) patrol_count,  nvl(aastt.speed_count,0) speed_count,  region_count, nvl(aaptt.point_count,0) point_count,  nvl(task.task_count,0) task_count, trunc(nvl(salaryt.rate_pass,0),4) as rate_pass ,  trunc(nvl(salaryt.day_pass * patt.month_salary,0) / 30,2) as money
 from 
   (select pat.target_id ,  pat.month_salary from pipe_attendant pat) patt, 
   (select count(*) as patrol_count,  atpt.target_id from axiom_track_patrol atpt  where atpt.gps_time between s_time and e_time group by atpt.target_id) atptt, 
   (select count(*) as speed_count, aast.target_id  from axiom_alarm_speed aast where aast.gps_time between s_time and e_time  group by aast.target_id) aastt, 
   (select count(*) as v_region_count, aart.target_id  from axiom_alarm_region aart where aart.gps_time between s_time and e_time  group by aart.target_id) aartt, 
   (select target_id , sum(leak_piont_count) as region_count from( select base.target_id, trunc(nvl(t_point_count - piont_count, t_point_count)/t_point_count) as leak_piont_count from (select target_id, gps_date,count(gps_date) as piont_count from( select target_id,to_char(trunc(axiom_utc_to_date(gps_time)), 'yyyy-mm-dd') as gps_date, point_id from axiom_alarm_point where gps_time  between s_time and e_time  group by target_id,trunc(axiom_utc_to_date(gps_time)),point_id ) group by target_id,gps_date ) point, (select target_id, gps_date from (select substr(target_id_val, s, e - s) target_id from (select pos_start.pos as s, pos_end.pos as e from (select rownum rn, pos from  (select distinct pos from (select instr(concat(',', target_id_val), ',',  rownum) as pos from dual connect by rownum <= length(target_id_val)) where pos > 0 order by pos)) pos_start,   (select rownum rn, pos from (select distinct pos from (select instr(concat(target_id_val, ','), ',', rownum) as pos from dual connect by rownum <= length(target_id_val)) where pos > 0 order by pos)) pos_end where pos_start.rn = pos_end.rn)) target_base,   (select to_char(axiom_utc_to_date((trunc(s_time / (24 * 60 * 60)) + rownum) * (24 * 60 * 60)), 'yyyy-mm-dd') as gps_date from dual connect by rownum <= (trunc((e_time - s_time) / (24 * 60 * 60)) + 1)) date_base) base , (select count(point_id)as t_point_count,target_id from axiom_analyze_target_point group by target_id ) target_point  where base.gps_date = point.gps_date(+) and base.target_id = point.target_id(+)  and base.target_id = target_point.target_id(+) ) group by target_id ) tpc,
   (select  target_id , sum(leak_piont_count) as point_count from( select  base.target_id, nvl(t_point_count - piont_count, t_point_count) as leak_piont_count from 
        ( select target_id, gps_date,count(gps_date) as piont_count from( select target_id,to_char(trunc(axiom_utc_to_date(gps_time)), 'yyyy-mm-dd') as gps_date, point_id from axiom_alarm_point where gps_time  between s_time and e_time  group by target_id,trunc(axiom_utc_to_date(gps_time)),point_id ) group by target_id,gps_date ) point,
        (select target_id, gps_date from (select substr(target_id_val, s, e - s) target_id from (select pos_start.pos as s, pos_end.pos as e from (select rownum rn, pos from (select distinct pos from (select instr(concat(',', target_id_val), ',',  rownum) as pos from dual connect by rownum <= length(target_id_val)) where pos > 0 order by pos)) pos_start,  (select rownum rn, pos from (select distinct pos from (select instr(concat(target_id_val, ','), ',', rownum) as pos from dual connect by rownum <= length(target_id_val)) where pos > 0 order by pos)) pos_end where pos_start.rn = pos_end.rn)) target_base,  (select to_char(axiom_utc_to_date((trunc(s_time / (24 * 60 * 60)) + rownum ) * (24 * 60 * 60)), 'yyyy-mm-dd') as gps_date from dual connect by rownum <= (trunc((e_time - s_time) / (24 * 60 * 60)) + 1)) date_base) base ,
        (select count(point_id)as t_point_count,target_id from axiom_analyze_target_point group by target_id ) target_point  where base.gps_date = point.gps_date(+) and base.target_id = point.target_id(+)  and base.target_id = target_point.target_id(+) ) group by target_id ) aaptt ,
    (select target_id, count(task_date) as task_count from pipe_special_task where task_date between s_time and e_time group by target_id,trunc(axiom_utc_to_date(task_date)) ) task,
   (select att.target_id, att.target_name  from axiom_target att  where att.target_id in (select substr(target_id_val, s, e - s)  from (select pos_start.pos as s, pos_end.pos as e from  (select rownum rn, pos from (select distinct pos from  (select instr(concat(',', target_id_val),',', rownum) as pos from dual  connect by rownum <= length(target_id_val))  where pos > 0  order by pos)) pos_start, (select rownum rn, pos from (select distinct pos  from (select instr(concat(target_id_val, ','), ',',  rownum) as pos from dual  connect by rownum <= length(target_id_val)) where pos > 0 order by pos)) pos_end  where pos_start.rn = pos_end.rn))) attt, 
   (select target_id,  count(*)  as day_pass,count(*)/(trunc((e_time - s_time) / (24 * 60 * 60)) + 1) as rate_pass 
     from (
select gps_date, target_id, leak_piont_count, task_count, sign(sign(leak_piont_count * 2 - 1) + sign(task_count) * -2) total_pass 
from( select base.gps_date, base.target_id, nvl(piont_count, 0) piont_count, nvl(task_count, 0) task_count, nvl(t_point_count, 0) t_point_count , nvl(t_point_count - piont_count, t_point_count) leak_piont_count from 
        (select target_id, to_char(trunc(axiom_utc_to_date(gps_time)), 'yyyy-mm-dd') as gps_date,  count(*) as patrol_count from axiom_track_patrol where bitand(terminal_status, 16) = 16 and gps_time between s_time and e_time group by target_id, trunc(axiom_utc_to_date(gps_time))) patrol, 
        (select target_id, to_char(trunc(axiom_utc_to_date(gps_time)), 'yyyy-mm-dd') as gps_date, count(gps_time) as speed_count from axiom_alarm_speed where gps_time between s_time and e_time group by target_id,trunc(axiom_utc_to_date(gps_time))) speed, 
        (select target_id,to_char(trunc(axiom_utc_to_date(gps_time)), 'yyyy-mm-dd') as gps_date, count(gps_time) as region_count from axiom_alarm_region where gps_time between s_time and e_time group by target_id,trunc(axiom_utc_to_date(gps_time))) region,
        ( select target_id, gps_date,count(gps_date) as piont_count from( select target_id,to_char(trunc(axiom_utc_to_date(gps_time)), 'yyyy-mm-dd') as gps_date, point_id from axiom_alarm_point where gps_time  between s_time and e_time  group by target_id,trunc(axiom_utc_to_date(gps_time)),point_id ) group by target_id,gps_date ) point,
        (select target_id,to_char(trunc(axiom_utc_to_date(task_date)), 'yyyy-mm-dd') as task_date, count(task_date) as task_count from pipe_special_task where task_date between s_time and e_time group by target_id,trunc(axiom_utc_to_date(task_date)) ) task,
        (select target_id, gps_date from (select substr(target_id_val, s, e - s) target_id from (select pos_start.pos as s, pos_end.pos as e from (select rownum rn, pos from (select distinct pos from (select instr(concat(',', target_id_val), ',',  rownum) as pos from dual connect by rownum <= length(target_id_val)) where pos > 0 order by pos)) pos_start,  (select rownum rn, pos from (select distinct pos from (select instr(concat(target_id_val, ','), ',', rownum) as pos from dual connect by rownum <= length(target_id_val)) where pos > 0 order by pos)) pos_end where pos_start.rn = pos_end.rn)) target_base,  (select to_char(axiom_utc_to_date((trunc(s_time / (24 * 60 * 60)) + rownum ) * (24 * 60 * 60)), 'yyyy-mm-dd') as gps_date from dual connect by rownum <= (trunc((e_time - s_time) / (24 * 60 * 60)) + 1)) date_base) base ,
        (select count(point_id)as t_point_count,target_id from axiom_analyze_target_point group by target_id ) target_point
         where base.gps_date = patrol.gps_date(+)  and base.gps_date = speed.gps_date(+)  and base.gps_date = region.gps_date(+)  and base.gps_date = point.gps_date(+)   and base.gps_date = task.task_date(+)   and base.target_id = patrol.target_id(+)  and base.target_id = speed.target_id(+)  and base.target_id = region.target_id(+)  and base.target_id = point.target_id(+)   and base.target_id = task.target_id(+)  and base.target_id = target_point.target_id(+)  ) order by target_id, gps_date )  vtable  where vtable.total_pass = -1 group by target_id  ) salaryt 
   
   where attt.target_id = patt.target_id(+)  and attt.target_id = atptt.target_id(+)  and attt.target_id = aastt.target_id(+)  and attt.target_id = aartt.target_id(+)  and attt.target_id = aaptt.target_id(+)  and attt.target_id = salaryt.target_id(+)  and attt.target_id = task.target_id(+) and attt.target_id = tpc.target_id(+) order by  attt.target_name ;

 LOOP 
     FETCH R INTO v_s_date,v_e_date,v_target_name,v_patrol_count, v_speed_count,v_region_count, v_point_count, v_task_count, v_rate_pass , v_money;
    -- FETCH R INTO money;
     EXIT WHEN R%NOTFOUND;     
     target_name_count := target_name_count+1;   
     patrol_count := patrol_count+v_patrol_count;
     speed_count :=speed_count+v_speed_count;
     region_count :=region_count+v_region_count;
     point_count :=point_count+v_point_count;
     task_count :=task_count+v_task_count;
     rate_pass :=rate_pass+v_rate_pass;
     money :=money+v_money;
     
     PIPE ROW(report_matter( v_s_date,v_e_date,v_target_name,v_patrol_count, v_speed_count,v_region_count, v_point_count, v_task_count,v_rate_pass*100 , v_money));
      
   END LOOP;
  -- FETCH R INTO v_target_name,v_patrol_count, v_speed_count,v_region_count, v_point_count, v_task_count,
 --   v_rate_pass , v_money;
      
     PIPE ROW(report_matter('','汇总', '人数：'||target_name_count,patrol_count, speed_count,region_count, point_count, task_count, (rate_pass/target_name_count)*100 , money));

close R;
RETURN;
end axiom_report_matter;


